# 0x00 CSRF漏洞 
CSRF (Cross Site Request Forgery)，中文全称跨站点请求伪造

- 1.对网站管理员进行攻击
- 2.修改受害网站上的用户账户和数据
- 3.账户劫持
- 4.传播CSRF蠕虫进行大规模攻击
- 5.利用csrf进行拖库
- 6.利用其他漏洞进行组合拳攻击
- 7.针对路由器的csrf攻击

----------

# 0x01 CSRF的形成原理危害

- 案例一
一个银行站点存在一个csrf漏洞，用户A转账给B用户2000元，执行转账操作后会对银行发送一次请求：http://www.bank.com/money?user=A&num=2000&transfer=B，然后A用户就会把自己的2000元转到B的账户下。在发送这个请求给银行服务器时，服务器首先会验证这个请求是否为一个合法的session，并且用户A确认登陆才可以验证通过。如果此时有一个恶意用户C想把A用户的钱转到自己的账户下，那么他可以构造 http://www.bank.com/money?user=A&num=2000&transfer=C 这个请求，但是这个请求必须有A用户发出才可以生效，此时恶意用户C可以搭建一个自己的网站，在网站中写入如下代码 <img src="http://www.bank.com/money?user=A&num=2000&transfer=C">,之后诱导A用户访问自己的网站，当A访问这个网站时，这个网站就会把img标签里的URL发给银行服务器，而此时除了这个请求以外，还会把A用户的cookie一起发到服务器，如果此时A用户的浏览器与银行的session没有过期，那么就会在A用户毫不知情的情况下执行转账给C的操作。

- 案例二
一个cms系统的管理后台，可以发送一个post请求添加一个管理员，由于没有加token或者验证码限制，恶意攻击者可以在自己的服务器evil.com上建立一个a.html的文件，a.html文件是一个添加管理员账户的表单，上面写入需要添加的账户用户名及密码，当网站管理员打开evil.com/a.html的时候，并且管理员的session没有失效，那么此时a.html就会请求受攻击网站，在管理员毫不知情的情况下添加一个后台账户。


- 结论
 
	通过以上两个案例可以得出结论，csrf会根据业务功能场景的不用而利用起来也不同，这些请求都是跨域发起的，而且是在受害者的session没有失效通过身份认证的情况下发生的。	
	使用用户的登陆凭证，让用户自己在不知情的情况下，进行修改数据的操作。
	但是查询数据的地方却不需要保护，因为csrf是借助受害者的cookie来进行攻击者需要的恶意操作的，攻击者并不能拿到受害者cookie，对于服务器返回的结果也无法解析查看，攻击者唯一可以做的就是让服务器执行自己的操作命令，或者说改变网站数据，而查询操作即不会改变数据也不会把结果返回给攻击者，所以并不需要保护。


#0x02  CSRF的分类


## GET类型的CSRF
	
- 这种类型的CSRF一般是由于程序员安全意识不强造成的。GET类型的CSRF利用非常简单，只需要一个HTTP请求，所以，一般会这样利用：

	`<img src=http://wooyun.org/csrf.php?xx=11 /> `

	在访问含有这个img的页面后，成功向http://wooyun.org/csrf.php?xx=11发出了一次HTTP请求。所以，如果将该网址替换为存在GET型CSRF的地址，就能完成攻击了。
 

## POST类型的CSRF

- 这种类型的CSRF危害没有GET型的大，利用起来通常使用的是一个自动提交的表单，如：
    
        <form action=http://wooyun.org/csrf.php method=POST>
    		<input type="text" name="xx" value="11" />
    	</form>
    	<script> document.forms[0].submit(); </script> 
    
    
	访问该页面后，表单会自动提交，相当于模拟用户完成了一次POST操作。

----------

#0x03  CSRF的防范

----------

## 验证码

- CSRF攻击的过程，往往是在用户不知情的情况下构造网络请求。所以如果使用验证码，那么每次操作都需要用户进行互动，从而简单有效的防御了CSRF攻击。

## 检测refer

- 常见的互联网页面与页面之间是存在联系的，比如你在www.baidu.com应该是找不到通往www.google.com的链接的，再比如你在论坛留言，那么不管你留言后重定向到哪里去了，之前的那个网址一定会包含留言的输入框，这个之前的网址就会保留在新页面头文件的Referer中

- 通过检查Referer的值，我们就可以判断这个请求是合法的还是非法的，但是问题出在服务器不是任何时候都能接受到Referer的值，所以Refere Check 一般用于监控CSRF攻击的发生，而不用来抵御攻击.

- 另一种情况是csrf结合xss进行攻击，此时就不需要跨域发起，也可以绕过referer验证。 

## Token

目前主流的做法是使用Token抵御CSRF攻击。下面通过分析CSRF 攻击来理解为什么Token能够有效?
在说token如何防御csrf攻击之前，我们先了解下token的工作原理。当用户第一次进行登陆的时候，客户端会通过用户名和密码去请求服务器登陆，服务端在收到请求后会验证客户端传来的用户名和密码，如果验证通过，服务器就会签发一个token发给客户端，并且将token放到session中，客户端收到token后存储到本地，以后客户端只要每次请求服务器就要带上token，经过服务器验证通过后才会返回响应数据，否则报错。

- CSRF攻击要成功的条件在于攻击者能够预测所有的参数从而构造出合法的请求。所以根据不可预测性原则，我们可以对参数进行加密从而防止CSRF攻击。

- 另一个更通用的做法是保持原有参数不变，另外添加一个参数Token，其值是随机的。这样攻击者因为不知道Token而无法构造出合法的请求进行攻击。


- **Token 使用原则**

    	Token要足够随机————只有这样才算不可预测

    	Token是一次性的，即每次请求成功后要更新Token————这样可以增加攻击难度，增加预测难度

    	Token要注意保密性————敏感操作使用post，防止Token出现在URL中
    













----------
